{% extends "layout.html" %}

{% block title %}Lịch sử quét - Vulnerability Scanner{% endblock %}

{% block head %}
<style>
    .history-header {
        background: linear-gradient(135deg, #4a00e0, #8e2de2);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    .scan-history-item {
        border-radius: 10px;
        transition: all 0.3s;
        cursor: pointer;
    }
    .scan-history-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .scan-meta {
        font-size: 0.9rem;
        color: #666;
    }
    .scan-status {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
    }
    .scan-url {
        word-break: break-all;
    }
    .vuln-count-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        padding: 0.5rem 0.75rem;
        border-radius: 50%;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .search-box {
        border-radius: 30px;
        padding-left: 20px;
        border: 1px solid #ddd;
    }
    .search-box:focus {
        box-shadow: 0 0 0 0.25rem rgba(74, 0, 224, 0.25);
        border-color: #4a00e0;
    }
    .no-scans-card {
        background: linear-gradient(135deg, #f5f7fa, #e4e8f0);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="history-header">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h1><i class="fas fa-history me-2"></i>Lịch sử quét</h1>
        <div class="d-flex">
            <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                <i class="fas fa-plus me-2"></i>Quét mới
            </a>
        </div>
    </div>
    <p class="lead mb-0">Xem lại kết quả của các lần quét trước đây</p>
</div>

{% if scans %}
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-md-0">Tổng số lần quét: <span class="badge bg-primary">{{ scans|length }}</span></h5>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control search-box border-start-0" id="scan-search" 
                           placeholder="Tìm kiếm theo URL, trạng thái, ID...">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    {% for scan in scans %}
    <div class="col-md-6 col-lg-4 scan-history-item">
        <div class="card h-100 position-relative">
            {% if scan.status == "completed" and scan.has_vulnerabilities %}
            <div class="vuln-count-badge bg-danger text-white">{{ scan.vuln_count }}</div>
            {% endif %}
            
            <div class="card-body">
                <div class="scan-status">
                    {% if scan.status == "running" %}
                    <span class="badge bg-primary"><i class="fas fa-spinner fa-spin me-1"></i> Đang quét</span>
                    {% elif scan.status == "completed" %}
                    <span class="badge bg-success"><i class="fas fa-check me-1"></i> Hoàn thành</span>
                    {% elif scan.status == "error" %}
                    <span class="badge bg-danger"><i class="fas fa-times me-1"></i> Lỗi</span>
                    {% endif %}
                </div>
                
                <h5 class="card-title mb-3 mt-2">
                    <a href="{{ url_for('scan_status', scan_id=scan.id) }}" class="text-decoration-none">
                        <i class="fas fa-globe text-primary me-2"></i>
                        <span class="scan-url">{{ scan.url }}</span>
                    </a>
                </h5>
                
                <div class="d-flex mb-3 scan-meta">
                    <div class="me-3">
                        <i class="fas fa-calendar text-muted me-1"></i>
                        {{ scan.start_time }}
                    </div>
                    <div>
                        <i class="fas fa-fingerprint text-muted me-1"></i>
                        {{ scan.id }}
                    </div>
                </div>
                
                <div class="mb-3">
                    {% for vuln in scan.vulnerabilities %}
                    {% if vuln == "xss" %}
                    <span class="badge bg-danger vulnerability-badge">XSS</span>
                    {% elif vuln == "sqli" %}
                    <span class="badge bg-warning text-dark vulnerability-badge">SQL Injection</span>
                    {% elif vuln == "open_redirect" %}
                    <span class="badge bg-primary vulnerability-badge">Open Redirect</span>
                    {% elif vuln == "path_traversal" %}
                    <span class="badge bg-info text-dark vulnerability-badge">Path Traversal</span>
                    {% elif vuln == "csrf" %}
                    <span class="badge bg-success vulnerability-badge">CSRF</span>
                    {% endif %}
                    {% endfor %}
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('scan_status', scan_id=scan.id) }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Xem chi tiết
                    </a>
                    
                    <div class="btn-group">
                        {% if scan.status == "completed" %}
                        <a href="{{ url_for('view_report', scan_id=scan.id) }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-file-alt me-1"></i>Xem báo cáo
                        </a>
                        {% endif %}
                        
                        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{ scan.id }}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal{{ scan.id }}" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa kết quả quét URL: <strong>{{ scan.url }}</strong>?</p>
                    <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Hành động này không thể hoàn tác.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <form action="{{ url_for('delete_scan', scan_id=scan.id) }}" method="post">
                        <button type="submit" class="btn btn-danger delete-scan-btn">Xác nhận xóa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="alert alert-info mt-4 d-none" id="no-results">
    <i class="fas fa-search me-2"></i>Không tìm thấy kết quả nào phù hợp với từ khóa tìm kiếm.
</div>

{% else %}
<div class="card text-center no-scans-card py-5">
    <div class="card-body">
        <i class="fas fa-search fa-4x mb-3 text-muted"></i>
        <h3 class="mb-3">Không có lịch sử quét</h3>
        <p class="mb-4">Chưa có lần quét nào được thực hiện hoặc tất cả đã bị xóa.</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Bắt đầu quét mới
        </a>
    </div>
</div>
{% endif %}

{% endblock %} 