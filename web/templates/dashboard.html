{% extends "base.html" %}

{% block title %}Dashboard - Vulnerability Scanner{% endblock %}

{% block header_title %}Security Dashboard{% endblock %}

{% block content %}
<div class="container">
    <!-- Statistics Cards Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 bg-light">
                <div class="card-body text-center">
                    <h3 class="counter-value" id="total-scans">--</h3>
                    <p class="text-muted mb-0">Total Scans</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-light">
                <div class="card-body text-center">
                    <h3 class="counter-value" id="total-vulns">--</h3>
                    <p class="text-muted mb-0">Vulnerabilities Found</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-light">
                <div class="card-body text-center">
                    <h3 class="counter-value" id="avg-time">--</h3>
                    <p class="text-muted mb-0">Average Scan Time</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-light">
                <div class="card-body text-center">
                    <h3 class="counter-value" id="last-scan">--</h3>
                    <p class="text-muted mb-0">Last Scan</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Vulnerability Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="vulnDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Scan Activity</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="scanActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Scans Table -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Scans</h5>
            <a href="{{ url_for('history_page') }}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
            <!-- Loading indicator -->
            <div id="recentScansLoader" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading recent scans...</p>
            </div>
            
            <!-- No scans message -->
            <div id="noScansMessage" class="alert alert-info" style="display: none;">
                <i class="bi bi-info-circle me-2"></i>
                No scan history found. <a href="{{ url_for('scan_page') }}" class="alert-link">Run your first scan</a> to get started.
            </div>
            
            <!-- Error message -->
            <div id="errorMessage" class="alert alert-danger" style="display: none;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span id="errorText">Failed to load scan history.</span>
                <button class="btn btn-outline-danger btn-sm ms-3" onclick="loadDashboardData()">
                    <i class="bi bi-arrow-clockwise me-1"></i> Retry
                </button>
            </div>
            
            <!-- Recent scans table -->
            <div id="recentScansTable" style="display: none;">
                <!-- Table will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load dashboard data
        loadDashboardData();
        
        // Set up theme-aware Chart.js
        setupChartTheme();
    });
    
    function setupChartTheme() {
        // Get current theme
        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
        
        // Set Chart.js defaults based on theme
        Chart.defaults.color = isDarkMode ? '#e0e0e0' : '#666666';
        Chart.defaults.borderColor = isDarkMode ? '#2d2d3a' : '#eeeeee';
    }
    
    function loadDashboardData() {
        const loader = document.getElementById('recentScansLoader');
        const table = document.getElementById('recentScansTable');
        const noScans = document.getElementById('noScansMessage');
        const errorMsg = document.getElementById('errorMessage');
        
        // Show loader, hide everything else
        loader.style.display = 'block';
        table.style.display = 'none';
        noScans.style.display = 'none';
        errorMsg.style.display = 'none';
        
        fetch('/api/history')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Data received successfully
                console.log('Dashboard data:', data);
                
                // Hide loader
                loader.style.display = 'none';
                
                if (!data || data.length === 0) {
                    // Show no scans message if empty
                    noScans.style.display = 'block';
                    return;
                }
                
                // Process and display the data
                displayDashboardData(data);
                
                // Show table
                table.style.display = 'block';
            })
            .catch(error => {
                // Handle error
                console.error('Error loading dashboard data:', error);
                loader.style.display = 'none';
                errorMsg.style.display = 'block';
                document.getElementById('errorText').textContent = error.message || 'Failed to load scan history.';
            });
    }
    
    function displayDashboardData(historyData) {
        // Calculate statistics
        const totalScans = historyData.length;
        let totalVulnerabilities = 0;
        let totalScanTime = 0;
        let latestScanTimestamp = 0;
        
        // Prepare data for charts
        let vulnerabilityTypes = {
            'critical': 0,
            'high': 0,
            'medium': 0,
            'low': 0
        };
        
        let scanDates = {};
        
        // Process all scan data
        historyData.forEach(scan => {
            // Total vulnerabilities
            const vulnCount = parseInt(scan.vulnerabilities) || 0;
            totalVulnerabilities += vulnCount;
            
            // Scan time calculation
            if (scan.duration && scan.duration !== 'N/A') {
                const duration = parseFloat(scan.duration);
                if (!isNaN(duration)) {
                    totalScanTime += duration;
                }
            }
            
            // Latest scan date
            const timestamp = scan.timestamp ? parseInt(scan.timestamp) : 0;
            if (timestamp > latestScanTimestamp) {
                latestScanTimestamp = timestamp;
            }
            
            // Group scans by date for activity chart
            if (timestamp) {
                const scanDate = new Date(timestamp * 1000).toLocaleDateString();
                scanDates[scanDate] = (scanDates[scanDate] || 0) + 1;
            }
        });
        
        // Update statistics cards
        document.getElementById('total-scans').textContent = totalScans;
        document.getElementById('total-vulns').textContent = totalVulnerabilities;
        
        // Calculate average scan time
        if (totalScans > 0 && totalScanTime > 0) {
            const avgTime = totalScanTime / totalScans;
            document.getElementById('avg-time').textContent = formatDuration(avgTime);
        } else {
            document.getElementById('avg-time').textContent = '0:00';
        }
        
        // Display last scan date
        if (latestScanTimestamp > 0) {
            const lastScanDate = new Date(latestScanTimestamp * 1000);
            document.getElementById('last-scan').textContent = lastScanDate.toLocaleDateString();
        } else {
            document.getElementById('last-scan').textContent = 'Never';
        }
        
        // Display recent scans table
        const recentScansTable = document.getElementById('recentScansTable');
        
        // Get only the 5 most recent scans
        const recentScans = historyData.slice(0, 5);
        
        const tableHTML = `
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Target URL</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentScans.map(scan => {
                            // Format date display
                            let dateDisplay = formatDate(scan.timestamp, scan.date);
                            
                            // Format status display
                            const status = scan.status || 'Unknown';
                            const statusClass = getStatusClass(status);
                            
                            // Determine report path
                            let reportPath = '';
                            if (scan.report_json_path) {
                                reportPath = scan.report_json_path;
                            } else if (scan.report_md_path) {
                                reportPath = scan.report_md_path;
                            } else if (scan.report_file) {
                                reportPath = extractReportPath(scan.report_file) || scan.report_file;
                            }
                            
                            return `
                                <tr>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;" title="${scan.target_url || 'N/A'}">
                                            <a href="${scan.target_url || '#'}" target="_blank" class="text-decoration-none">
                                                <i class="bi bi-link-45deg"></i> ${scan.target_url || 'N/A'}
                                            </a>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge ${scan.scan_type === 'full' ? 'bg-success' : 'bg-primary'}">
                                            ${scan.scan_type === 'full' ? 'Full' : 'Basic'}
                                        </span>
                                    </td>
                                    <td>${dateDisplay}</td>
                                    <td>
                                        <span class="badge ${statusClass}">
                                            ${status}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        ${reportPath ? 
                                            `<a href="/report/${encodeURIComponent(reportPath)}" class="btn btn-sm btn-primary">
                                                <i class="bi bi-file-text"></i> View
                                            </a>` : 
                                            `<button class="btn btn-sm btn-secondary" disabled>
                                                <i class="bi bi-file-earmark-x"></i> N/A
                                            </button>`
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        recentScansTable.innerHTML = tableHTML;
        recentScansTable.style.display = 'block';
        
        // Create charts
        createVulnerabilityDistributionChart(vulnerabilityTypes);
        createScanActivityChart(scanDates);
    }
    
    function createVulnerabilityDistributionChart(vulnerabilityTypes) {
        const ctx = document.getElementById('vulnDistributionChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    label: 'Vulnerabilities',
                    data: [
                        vulnerabilityTypes.critical || 0,
                        vulnerabilityTypes.high || 0, 
                        vulnerabilityTypes.medium || 0, 
                        vulnerabilityTypes.low || 0
                    ],
                    backgroundColor: [
                        '#d9534f',  // Red (Critical)
                        '#f0ad4e',  // Orange (High)
                        '#5bc0de',  // Blue (Medium)
                        '#5cb85c'   // Green (Low)
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function createScanActivityChart(scanDates) {
        const ctx = document.getElementById('scanActivityChart').getContext('2d');
        
        // Get the dates sorted
        const dates = Object.keys(scanDates).sort((a, b) => new Date(a) - new Date(b));
        const scanCounts = dates.map(date => scanDates[date]);
        
        // If we have less than 7 dates, pad with empty ones
        while (dates.length < 7) {
            const lastDate = dates.length > 0 ? new Date(dates[dates.length - 1]) : new Date();
            lastDate.setDate(lastDate.getDate() + 1);
            dates.push(lastDate.toLocaleDateString());
            scanCounts.push(0);
        }
        
        // Limit to the 7 most recent dates
        const recentDates = dates.slice(-7);
        const recentCounts = scanCounts.slice(-7);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: recentDates,
                datasets: [{
                    label: 'Scans',
                    data: recentCounts,
                    backgroundColor: '#007bff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Helper function to format date
    function formatDate(timestamp, dateStr) {
        if (!timestamp && !dateStr) {
            return 'Unknown';
        }
        
        try {
            if (timestamp) {
                // Convert timestamp to date
                const date = new Date(parseInt(timestamp) * 1000);
                return date.toLocaleString();
            } else if (dateStr) {
                // Use provided date string
                return dateStr;
            }
        } catch (e) {
            console.error('Error formatting date:', e);
        }
        
        return 'Unknown';
    }
    
    // Helper function to format duration
    function formatDuration(duration) {
        if (!duration || duration === 'N/A') {
            return '-';
        }
        
        try {
            // Check if it's already in MM:SS format
            if (typeof duration === 'string' && duration.includes(':')) {
                return duration;
            }
            
            // Convert to number
            const seconds = parseFloat(duration);
            if (isNaN(seconds)) {
                return '-';
            }
            
            // Format as MM:SS
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        } catch (e) {
            console.error('Error formatting duration:', e);
        }
        
        return '-';
    }
    
    // Helper function to get status class
    function getStatusClass(status) {
        if (!status) return 'bg-secondary';
        
        const statusLower = status.toLowerCase();
        
        if (statusLower.includes('complet')) return 'bg-success';
        if (statusLower.includes('error')) return 'bg-danger';
        if (statusLower.includes('run')) return 'bg-primary';
        if (statusLower.includes('pend')) return 'bg-warning';
        
        return 'bg-secondary';
    }
    
    // Helper function to extract report path from legacy format
    function extractReportPath(reportFile) {
        if (!reportFile || typeof reportFile !== 'string') {
            return null;
        }
        
        // Try to match report_*.json or report_*.txt or report_*.md
        const matches = reportFile.match(/report_[^"\s]+\.(json|txt|md)/g);
        if (matches && matches.length > 0) {
            return matches[0];
        }
        
        return null;
    }
</script>
{% endblock %} 