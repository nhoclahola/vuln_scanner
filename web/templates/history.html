{% extends "base.html" %}

{% block title %}Scan History - Security Scanner{% endblock %}

{% block header_title %}Scan History{% endblock %}

{% block content %}
<div class="history-container">
    <!-- Search and Filter Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8 mb-3 mb-md-0">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="historySearch" class="form-control" placeholder="Search by URL or scan type...">
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="historyFilter" class="form-select">
                        <option value="all">All Scans</option>
                        <option value="basic">Basic Scans</option>
                        <option value="comprehensive">Comprehensive Scans</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History List -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Scan Records</h5>
        </div>
        <div class="card-body">
            <div id="historyItems">
                <div id="historyLoader" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading scan history...</span>
                    </div>
                    <p class="mt-2">Loading scan history...</p>
                </div>
                
                <div id="historyTable" style="display: none;">
                    <!-- History table will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- No History Alert -->
    <div id="noHistoryAlert" class="alert alert-info mt-4" style="display: none;">
        <i class="bi bi-info-circle me-2"></i> No scan history found. <a href="{{ url_for('scan_page') }}" class="alert-link">Run your first scan</a> to get started.
    </div>

    <!-- History Stats Card -->
    <div class="card mt-4" id="historyStats" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">Scan Statistics</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <div class="stat-details">
                            <p class="stat-title">Total Scans</p>
                            <h2 class="stat-value" id="stats-total-scans">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(231, 76, 60, 0.1);">
                            <i class="bi bi-bug" style="color: #e74c3c;"></i>
                        </div>
                        <div class="stat-details">
                            <p class="stat-title">Vulnerabilities Found</p>
                            <h2 class="stat-value" id="stats-total-vulns">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(243, 156, 18, 0.1);">
                            <i class="bi bi-clock" style="color: #f39c12;"></i>
                        </div>
                        <div class="stat-details">
                            <p class="stat-title">Average Scan Time</p>
                            <h2 class="stat-value" id="stats-avg-time">0:00</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(46, 204, 113, 0.1);">
                            <i class="bi bi-calendar3" style="color: #2ecc71;"></i>
                        </div>
                        <div class="stat-details">
                            <p class="stat-title">Last Scan</p>
                            <h2 class="stat-value" id="stats-last-scan">N/A</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load scan history data
        loadScanHistory();
        
        // Add search functionality
        const searchInput = document.getElementById('historySearch');
        const filterSelect = document.getElementById('historyFilter');
        
        if (searchInput && filterSelect) {
            searchInput.addEventListener('input', filterHistory);
            filterSelect.addEventListener('change', filterHistory);
        }
    });
    
    function loadScanHistory() {
        fetch('/api/history')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load scan history');
                }
                return response.json();
            })
            .then(data => {
                displayHistory(data);
            })
            .catch(error => {
                document.getElementById('historyLoader').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        ${error.message}
                    </div>
                `;
            });
    }
    
    function displayHistory(historyData) {
        const historyLoader = document.getElementById('historyLoader');
        const historyTable = document.getElementById('historyTable');
        const noHistoryAlert = document.getElementById('noHistoryAlert');
        const historyStats = document.getElementById('historyStats');
        
        // Hide loader
        historyLoader.style.display = 'none';
        
        if (!historyData || historyData.length === 0) {
            // Show no history alert
            noHistoryAlert.style.display = 'block';
            return;
        }
        
        // Show history table
        historyTable.style.display = 'block';
        
        // Calculate statistics
        const totalScans = historyData.length;
        let totalVulnerabilities = 0;
        let totalScanTime = 0;
        let latestScanDate = 0;
        
        // Format table
        const tableHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Target URL</th>
                        <th>Scan Type</th>
                        <th>Date</th>
                        <th>Duration</th>
                        <th>Vulnerabilities</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${historyData.map(item => {
                        // Calculate stats while iterating
                        if (item.vulnerabilities) {
                            totalVulnerabilities += item.vulnerabilities;
                        }
                        
                        if (item.duration) {
                            totalScanTime += parseFloat(item.duration);
                        }
                        
                        if (item.timestamp && item.timestamp > latestScanDate) {
                            latestScanDate = item.timestamp;
                        }
                        
                        // Format timestamp
                        let formattedDate = 'N/A';
                        if (item.timestamp) {
                            const date = new Date(item.timestamp * 1000);
                            formattedDate = date.toLocaleString();
                        }
                        
                        // Format report filename
                        let reportLink = '';
                        if (item.report_file) {
                            const reportFilename = item.report_file.split('/').pop();
                            reportLink = `<a href="/report/${reportFilename}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-file-earmark-text"></i> View Report</a>`;
                        }
                        
                        return `
                            <tr>
                                <td class="url-column">${item.target_url || 'N/A'}</td>
                                <td>${item.scan_type || 'Basic'}</td>
                                <td>${formattedDate}</td>
                                <td>${item.duration ? item.duration + 's' : 'N/A'}</td>
                                <td>
                                    <span class="badge ${item.vulnerabilities > 0 ? 'risk-high' : 'risk-low'}">
                                        ${item.vulnerabilities || 0}
                                    </span>
                                </td>
                                <td class="text-end">
                                    ${reportLink}
                                    ${item.report_file ? `
                                        <button class="btn btn-sm btn-outline-danger ms-2" 
                                                onclick="deleteReport('${item.report_file}')">
                                            <i class="bi bi-trash"></i>
                                        </button>` : ''}
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
        
        historyTable.innerHTML = tableHTML;
        
        // Update statistics
        document.getElementById('stats-total-scans').textContent = totalScans;
        document.getElementById('stats-total-vulns').textContent = totalVulnerabilities;
        
        // Calculate average scan time (in seconds)
        const avgScanTime = totalScanTime / totalScans;
        const minutes = Math.floor(avgScanTime / 60);
        const seconds = Math.floor(avgScanTime % 60);
        document.getElementById('stats-avg-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Format last scan date
        if (latestScanDate > 0) {
            const lastScanDate = new Date(latestScanDate * 1000);
            document.getElementById('stats-last-scan').textContent = lastScanDate.toLocaleDateString();
        }
        
        // Show stats card
        historyStats.style.display = 'block';
    }
    
    function filterHistory() {
        const searchTerm = document.getElementById('historySearch').value.toLowerCase();
        const filterValue = document.getElementById('historyFilter').value;
        
        const rows = document.querySelectorAll('#historyTable table tbody tr');
        
        rows.forEach(row => {
            const url = row.querySelector('td:first-child').textContent.toLowerCase();
            const scanType = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            
            const matchesSearch = url.includes(searchTerm) || scanType.includes(searchTerm);
            const matchesFilter = filterValue === 'all' || scanType.toLowerCase().includes(filterValue);
            
            row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
        });
    }
    
    function deleteReport(reportFile) {
        if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
            const filename = reportFile.split('/').pop();
            
            fetch(`/api/report/${filename}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete report');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Reload scan history
                    loadScanHistory();
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete report'));
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    }
</script>
{% endblock %} 