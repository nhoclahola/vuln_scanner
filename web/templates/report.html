{% extends "base.html" %}

{% block title %}Vulnerability Report - Security Scanner{% endblock %}

{% block header_title %}Vulnerability Report{% endblock %}

{% block content %}
<div class="report-container">
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Report Details</h5>
            <div class="d-flex">
                <div class="btn-group me-2" id="viewToggle" style="display: none;">
                    <button type="button" class="btn btn-sm btn-outline-primary active" id="jsonViewBtn">
                        <i class="bi bi-code-slash"></i> JSON View
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="markdownViewBtn">
                        <i class="bi bi-markdown"></i> Markdown View
                    </button>
                </div>
            <div id="reportActions" style="display: none;">
                <a id="downloadJsonBtn" href="#" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-download"></i> Download JSON
                </a>
                    <a id="downloadMdBtn" href="#" class="btn btn-sm btn-outline-primary ms-2">
                        <i class="bi bi-file-text"></i> Download Markdown
                </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="reportLoader" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading report...</span>
                </div>
                <p class="mt-2">Loading report details...</p>
            </div>
            
            <div id="reportSummary" style="display: none;">
                <!-- Report summary will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Visualization Dashboard Section -->
    <div id="visualizationDashboard" class="card mb-4" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">Vulnerability Dashboard</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Severity Distribution</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="severityChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Vulnerability Type</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="vulnerabilityTypeChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">CVSS Risk Score</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="cvssScoreChart" width="800" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="vulnerabilities" class="vulnerability-list"></div>
    
    <!-- Markdown Report Container -->
    <div id="markdownReport" class="card mb-4" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">Vulnerability Report (Markdown)</h5>
        </div>
        <div class="card-body">
            <div id="markdownContent" class="markdown-content"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include Markdown parser for rendering markdown reports -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Include Chart.js for visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Extract the actual report filename from the URL path
        const pathParts = window.location.pathname.split('/');
        let reportPath = pathParts[pathParts.length - 1];
        reportPath = decodeURIComponent(reportPath);
        
        if (!reportPath || reportPath === 'undefined') {
            document.getElementById('reportLoader').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i> Invalid report path.
                </div>
                <div class="mt-3">
                    <a href="/history" class="btn btn-primary">
                        <i class="bi bi-arrow-left"></i> Return to History
                    </a>
                </div>
            `;
            return;
        }
        
        // Logic xác định jsonPath, mdPath và download buttons giữ nguyên
        // ... (phần code từ dòng 129 đến 154 của file gốc giữ nguyên) ...
        let jsonPath, mdPath;
        
        if (reportPath.endsWith('.json')) {
            jsonPath = reportPath;
            mdPath = reportPath.replace('.json', '.md');
        } else if (reportPath.endsWith('.md')) {
            mdPath = reportPath;
            jsonPath = reportPath.replace('.md', '.json');
        } else if (reportPath.endsWith('.txt')) {
            jsonPath = reportPath.replace('.txt', '.json');
            mdPath = reportPath.replace('.txt', '.md');
        } else {
            // If no file extension, assume it might be a base name, try to append.
            // The initial loadReport will try the given reportPath first.
            // Fallbacks can try .json and .md
            jsonPath = reportPath + '.json'; // Default to try
            mdPath = reportPath + '.md';   // Default to try
        }
        
        document.getElementById('downloadJsonBtn').href = `/api/report/${encodeURIComponent(jsonPath)}`;
        document.getElementById('downloadJsonBtn').download = jsonPath.split('/').pop();
        
        document.getElementById('downloadMdBtn').href = `/api/report/${encodeURIComponent(mdPath)}`;
        document.getElementById('downloadMdBtn').download = mdPath.split('/').pop();
        
        document.getElementById('reportActions').style.display = 'block';


        const jsonViewBtn = document.getElementById('jsonViewBtn');
        const markdownViewBtn = document.getElementById('markdownViewBtn');
        
        window.reportData = {
            jsonData: null,
            markdownData: null,
            currentPath: reportPath, // The path derived from URL, used as a base for switching
            currentLoadedJsonPath: null,
            currentLoadedMarkdownPath: null,
            hasVulnerabilities: false
        };
        
        jsonViewBtn.addEventListener('click', function() {
            if (!this.classList.contains('active')) {
                showJsonView();
            }
        });
        
        markdownViewBtn.addEventListener('click', function() {
            if (!this.classList.contains('active')) {
                showMarkdownView();
            }
        });
        
        loadReport(reportPath); // Load the initial report based on URL
    });

    function showLoadError(error, originalPath) {
        document.getElementById('reportLoader').style.display = 'block'; // Ensure loader area is visible
        document.getElementById('reportLoader').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i> ${escapeHtml(error.message || 'Failed to load report.')}
            </div>
            <div class="mt-3">
                <p>Could not load report for: <strong>${escapeHtml(originalPath)}</strong></p>
                <p>Possible reasons:</p>
                <ul>
                    <li>The report file may have been deleted or is not accessible.</li>
                    <li>The server might be experiencing issues.</li>
                </ul>
                <p>
                    <a href="/history" class="btn btn-primary">
                        <i class="bi bi-arrow-left"></i> Return to History
                    </a>
                </p>
            </div>
        `;
        // Hide other sections
        document.getElementById('reportSummary').style.display = 'none';
        document.getElementById('visualizationDashboard').style.display = 'none';
        document.getElementById('vulnerabilities').style.display = 'none';
        document.getElementById('markdownReport').style.display = 'none';
        document.getElementById('viewToggle').style.display = 'none';
    }

    function showJsonViewUIOnly() {
        document.getElementById('reportSummary').style.display = 'block';
        document.getElementById('visualizationDashboard').style.display = window.reportData.hasVulnerabilities ? 'block' : 'none';
        document.getElementById('vulnerabilities').style.display = 'block';
        document.getElementById('markdownReport').style.display = 'none';

        document.getElementById('jsonViewBtn').classList.add('active');
        document.getElementById('markdownViewBtn').classList.remove('active');
    }

    function showMarkdownViewUIOnly() {
        document.getElementById('reportSummary').style.display = 'none';
        document.getElementById('visualizationDashboard').style.display = 'none';
        document.getElementById('vulnerabilities').style.display = 'none';
        document.getElementById('markdownReport').style.display = 'block';

        document.getElementById('jsonViewBtn').classList.remove('active');
        document.getElementById('markdownViewBtn').classList.add('active');
    }
    
    function showJsonView() {
        showJsonViewUIOnly();

        let targetJsonPath = '';
        if (window.reportData.currentPath.endsWith('.md')) {
            targetJsonPath = window.reportData.currentPath.replace('.md', '.json');
        } else if (window.reportData.currentPath.endsWith('.json')) {
            targetJsonPath = window.reportData.currentPath;
        } else { // No extension or unknown, assume we want a .json
            targetJsonPath = window.reportData.currentPath + '.json';
        }

        if (!window.reportData.jsonData || window.reportData.currentLoadedJsonPath !== targetJsonPath) {
            console.log("[ReportHTML] JSON data missing or for different path, attempting to load:", targetJsonPath);
            document.getElementById('reportLoader').style.display = 'block';
             // Clear potential previous JSON content to avoid confusion while loading
            document.getElementById('reportSummary').innerHTML = '';
            document.getElementById('vulnerabilities').innerHTML = '';
            document.getElementById('visualizationDashboard').style.display = 'none';


            tryLoadReport(targetJsonPath)
                .then(() => {
                    window.reportData.currentLoadedJsonPath = targetJsonPath;
                    // displayReport (called by tryLoadReport) will handle UI population and hiding loader
                })
                .catch(error => {
                    console.error("[ReportHTML] Failed to load JSON report for JSON view:", error);
                    document.getElementById('reportLoader').style.display = 'none';
                    document.getElementById('reportSummary').innerHTML = 
                        `<div class="alert alert-danger">Failed to load JSON data (${escapeHtml(targetJsonPath)}): ${escapeHtml(error.message)}</div>`;
                    document.getElementById('visualizationDashboard').style.display = 'none';
                    document.getElementById('vulnerabilities').style.display = 'none';
                });
        } else {
            // JSON data already loaded and is for the correct path, UI is already set by showJsonViewUIOnly
            // and displayReport would have populated it.
            console.log("[ReportHTML] Correct JSON data already loaded, ensuring view.");
        }
    }

    function showMarkdownView() {
        showMarkdownViewUIOnly();

        let targetMdPath = '';
        if (window.reportData.currentPath.endsWith('.json')) {
            targetMdPath = window.reportData.currentPath.replace('.json', '.md');
        } else if (window.reportData.currentPath.endsWith('.md')) {
            targetMdPath = window.reportData.currentPath;
        } else { // No extension or unknown, assume we want a .md
            targetMdPath = window.reportData.currentPath + '.md';
        }
        
        if (window.reportData.markdownData && window.reportData.currentLoadedMarkdownPath === targetMdPath) {
            console.log("[ReportHTML] Correct Markdown data already loaded, ensuring view.");
            displayMarkdownReport(window.reportData.markdownData); 
        } else {
            console.log("[ReportHTML] Markdown data missing or for different path, attempting to load:", targetMdPath);
            document.getElementById('reportLoader').style.display = 'block'; 
            document.getElementById('markdownContent').innerHTML = ''; 

            tryLoadReport(targetMdPath)
                .then(() => {
                    window.reportData.currentLoadedMarkdownPath = targetMdPath;
                    // displayReport (called by tryLoadReport) will handle UI population and hiding loader
                })
                .catch(error => {
                    console.error("[ReportHTML] Failed to load Markdown report:", error);
                    document.getElementById('reportLoader').style.display = 'none';
                    document.getElementById('markdownContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load Markdown report (${escapeHtml(targetMdPath)}): ${escapeHtml(error.message)}
                        </div>
                    `;
                });
        }
    }
    
    function generateMarkdownFromJson(data) {
        // Generate a markdown representation of the JSON data
        let markdown = '';
        
        // Add header
        markdown += '# Vulnerability Scan Report\\n\\n';
        
        // Add summary section
        if (data.summary) {
            markdown += '## Summary\\n\\n';
            markdown += `- **Target URL**: ${data.summary.target_url || 'Unknown'}\\n`;
            markdown += `- **Scan Type**: ${data.summary.scan_type || 'Unknown'}\\n`;
            markdown += `- **Scan Date**: ${formatDate(data.summary.scan_timestamp)}\\n`;
            markdown += `- **Total Vulnerabilities**: ${data.summary.total_vulnerabilities || 0}\\n`;
            
            if (data.summary.critical_count !== undefined) {
                markdown += `- **Critical**: ${data.summary.critical_count}\\n`;
            }
            if (data.summary.high_count !== undefined) {
                markdown += `- **High**: ${data.summary.high_count}\\n`;
            }
            if (data.summary.medium_count !== undefined) {
                markdown += `- **Medium**: ${data.summary.medium_count}\\n`;
            }
            if (data.summary.low_count !== undefined) {
                markdown += `- **Low**: ${data.summary.low_count}\\n`;
            }
            
            markdown += `- **Overall Risk Level**: ${data.summary.overall_risk_level || 'Unknown'}\\n\\n`;
        }
        
        // Add vulnerabilities section
        if (data.vulnerabilities && data.vulnerabilities.length > 0) {
            markdown += '## Vulnerabilities\\n\\n';
            
            // Group by severity
            const criticalVulns = data.vulnerabilities.filter(v => v.severity && v.severity.toLowerCase().includes('critical'));
            const highVulns = data.vulnerabilities.filter(v => v.severity && v.severity.toLowerCase().includes('high'));
            const mediumVulns = data.vulnerabilities.filter(v => v.severity && v.severity.toLowerCase().includes('medium'));
            const lowVulns = data.vulnerabilities.filter(v => v.severity && v.severity.toLowerCase().includes('low'));
            
            // Add Critical vulnerabilities
            if (criticalVulns.length > 0) {
                markdown += '### Critical Severity\\n\\n';
                criticalVulns.forEach(vuln => {
                    markdown += formatVulnerabilityMarkdown(vuln);
                });
            }
            
            // Add High vulnerabilities
            if (highVulns.length > 0) {
                markdown += '### High Severity\\n\\n';
                highVulns.forEach(vuln => {
                    markdown += formatVulnerabilityMarkdown(vuln);
                });
            }
            
            // Add Medium vulnerabilities
            if (mediumVulns.length > 0) {
                markdown += '### Medium Severity\\n\\n';
                mediumVulns.forEach(vuln => {
                    markdown += formatVulnerabilityMarkdown(vuln);
                });
            }
            
            // Add Low vulnerabilities
            if (lowVulns.length > 0) {
                markdown += '### Low Severity\\n\\n';
                lowVulns.forEach(vuln => {
                    markdown += formatVulnerabilityMarkdown(vuln);
                });
            }
        } else {
            markdown += '## No vulnerabilities found\\n\\n';
        }
        
        return markdown;
    }

    function formatVulnerabilityMarkdown(vuln) {
        let md = '';
        md += `#### ${vuln.name || vuln.type || 'Unknown Vulnerability'}\\n\\n`;
        
        if (vuln.id) {
            md += `- **ID**: ${vuln.id}\\n`;
        }
        
        if (vuln.severity) {
            md += `- **Severity**: ${vuln.severity}\\n`;
        }
        
        if (vuln.cvss_score) {
            md += `- **CVSS Score**: ${vuln.cvss_score}\\n`;
        }
        
        if (vuln.location) {
            md += `- **Location**: ${vuln.location}\\n`;
        }
        
        if (vuln.parameter) {
            md += `- **Parameter**: ${vuln.parameter}\\n`;
        }
        
        if (vuln.description) {
            md += `\\n**Description**:\\n\\n${vuln.description}\\n\\n`;
        }
        
        if (vuln.remediation) {
            md += `**Remediation**:\\n\\n${vuln.remediation}\\n\\n`;
        }
        
        md += '---\\n\\n';
        return md;
    }


    function loadReport(initialPath) {
        console.log(`[ReportHTML] Initial loadReport for: ${initialPath}`);
        window.reportData.currentPath = initialPath;

        document.getElementById('reportLoader').style.display = 'block';
        document.getElementById('reportSummary').style.display = 'none';
        document.getElementById('visualizationDashboard').style.display = 'none';
        document.getElementById('vulnerabilities').style.display = 'none';
        document.getElementById('markdownReport').style.display = 'none';


        tryLoadReport(initialPath)
            .catch(error => {
                console.error(`[ReportHTML] Failed to load initial report ${initialPath}:`, error);
                let fallbackPath = null;
                if (initialPath.endsWith('.json')) {
                    fallbackPath = initialPath.replace('.json', '.md');
                } else if (initialPath.endsWith('.md')) {
                    fallbackPath = initialPath.replace('.md', '.json');
                } else if (!initialPath.includes('.')) { // No extension, default to trying JSON then MD
                     fallbackPath = initialPath + '.json';
                }

                if (fallbackPath) {
                    console.log(`[ReportHTML] Initial load failed. Trying fallback: ${fallbackPath}`);
                    return tryLoadReport(fallbackPath)
                        .catch(fallbackError => {
                            console.error(`[ReportHTML] Fallback load also failed for ${fallbackPath}:`, fallbackError);
                            // If first fallback (e.g. .json) failed and original had no extension, try .md
                            if (!initialPath.includes('.') && fallbackPath.endsWith('.json')) {
                                let lastAttemptPath = initialPath + '.md';
                                console.log(`[ReportHTML] Fallback ${fallbackPath} failed. Trying last attempt: ${lastAttemptPath}`);
                                return tryLoadReport(lastAttemptPath)
                                    .catch(finalError => showLoadError(finalError, initialPath));
                            }
                            showLoadError(fallbackError, initialPath); // Show error against original path after specific fallback
                        });
                } else {
                    showLoadError(error, initialPath);
                }
            });
    }
    
    function tryLoadReport(path) {
        console.log(`[ReportHTML] tryLoadReport called for: ${path}`);
        return fetch(`/api/report/${encodeURIComponent(path)}`)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        let errorDetail = `Server responded with status ${response.status} ${response.statusText}.`;
                        if (text) {
                            try {
                                const errJson = JSON.parse(text);
                                if (errJson && errJson.error) errorDetail = errJson.error;
                            } catch (e) {
                                errorDetail = (text.length > 0 && text.length < 500) ? text : `Server error (status ${response.status}). Response body not parseable as JSON.`;
                            }
                        }
                        console.error(`[ReportHTML] Fetch error for ${path}: ${errorDetail}`);
                        throw new Error(errorDetail);
                    });
                }
                if (path.endsWith('.md')) {
                    return response.text().then(textData => ({ type: 'markdown', content: textData, originalPath: path }));
                } else { 
                    return response.json().then(jsonData => ({ type: 'json', content: jsonData, originalPath: path }));
                }
            })
            .then(result => { 
                console.log(`[ReportHTML] Data received for ${result.originalPath}, type: ${result.type}`);
                if (result.type === 'markdown') {
                    window.reportData.markdownData = result.content;
                    window.reportData.currentLoadedMarkdownPath = result.originalPath; // Track what MD is loaded
                    displayReport(result.content, result.originalPath); 
                } else { 
                    window.reportData.jsonData = result.content;
                    window.reportData.currentLoadedJsonPath = result.originalPath; // Track what JSON is loaded
                    displayReport(result.content, result.originalPath);
                }
                return true; 
            });
    }
    
    function displayReport(data, path) {
        document.getElementById('reportLoader').style.display = 'none';
        document.getElementById('viewToggle').style.display = 'flex';

        if (path && path.endsWith('.md')) {
            // data here is the raw markdown string
            window.reportData.markdownData = data; // Ensure it's set
            window.reportData.currentLoadedMarkdownPath = path;
            displayMarkdownReport(data);
            showMarkdownViewUIOnly(); // Ensure correct UI and button state
            return;
        }
        
        // If not .md, assume it's JSON and data is the parsed JSON object
        window.reportData.jsonData = data; // Ensure it's set
        window.reportData.currentLoadedJsonPath = path;

        // Process JSON report (existing logic from original displayReport)
        const summarySection = document.getElementById('reportSummary');
        // summarySection.style.display = 'block'; // Handled by showJsonViewUIOnly
        showJsonViewUIOnly(); // Ensure correct UI and button state

        if (data.type === 'text' && data.text_result) {
            // ... (phần code từ dòng 440 đến 459 của file gốc giữ nguyên) ...
            summarySection.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Scan thành công nhưng không phát hiện lỗ hổng được cấu trúc. Xem kết quả text bên dưới.
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('vulnerabilities').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Scan Result (Text)</h5>
                    </div>
                    <div class="card-body">
                        <pre class="vulnerability-details">${escapeHtml(data.text_result)}</pre>
                    </div>
                </div>
            `;
            window.reportData.hasVulnerabilities = false; // No structured vulns for dashboard
            document.getElementById('visualizationDashboard').style.display = 'none';
            return;
        }
        
        let targetUrl = '';
        let scanDate = '';
        let totalVulns = 0;
        let vulnerabilities = [];
        
        if (data.summary) {
            // ... (phần code từ dòng 468 đến 488 của file gốc giữ nguyên) ...
            targetUrl = data.summary.target_url || '';
            if (data.summary.scan_timestamp) {
                if (typeof data.summary.scan_timestamp === 'number') {
                    scanDate = new Date(data.summary.scan_timestamp * 1000).toLocaleString();
                } else if (!isNaN(parseInt(data.summary.scan_timestamp))) {
                    scanDate = new Date(parseInt(data.summary.scan_timestamp) * 1000).toLocaleString();
                } else {
                    scanDate = data.summary.scan_timestamp;
                }
            }
            totalVulns = data.summary.total_vulnerabilities || 0;
            if (data.vulnerabilities && Array.isArray(data.vulnerabilities)) {
                vulnerabilities = data.vulnerabilities;
            }
        } 
        else if (data.findings) { // Older format
            // ... (phần code từ dòng 490 đến 515 của file gốc giữ nguyên) ...
            vulnerabilities = data.findings;
            totalVulns = vulnerabilities.length;
            if (data.target_url) {
                targetUrl = data.target_url;
            }
            if (data.scan_date) {
                if (typeof data.scan_date === 'number') {
                    scanDate = new Date(data.scan_date * 1000).toLocaleString();
                } else if (!isNaN(parseInt(data.scan_date))) {
                    scanDate = new Date(parseInt(data.scan_date) * 1000).toLocaleString();
                } else {
                    scanDate = data.scan_date;
                }
            } else if (data.timestamp) {
                if (typeof data.timestamp === 'number') {
                    scanDate = new Date(data.timestamp * 1000).toLocaleString();
                } else if (!isNaN(parseInt(data.timestamp))) {
                    scanDate = new Date(parseInt(data.timestamp) * 1000).toLocaleString();
                } else {
                    scanDate = data.timestamp;
                }
            }
        } else if (Array.isArray(data)) { // Direct array of vulnerabilities (very old format)
            vulnerabilities = data;
            totalVulns = vulnerabilities.length;
            // Try to find target and date from first vuln if possible (heuristic)
            if (vulnerabilities.length > 0 && vulnerabilities[0].target_url) {
                targetUrl = vulnerabilities[0].target_url;
            }
             // No reliable date for this format from top level
        }


        window.reportData.hasVulnerabilities = vulnerabilities.length > 0;
        
        let criticalCount = 0, highCount = 0, mediumCount = 0, lowCount = 0;
        vulnerabilities.forEach(vuln => {
            // ... (phần code từ dòng 523 đến 530 của file gốc giữ nguyên) ...
            if (!vuln.severity) return;
            const severity = vuln.severity.toLowerCase();
            if (severity.includes('critical')) criticalCount++;
            else if (severity.includes('high')) highCount++;
            else if (severity.includes('medium')) mediumCount++;
            else if (severity.includes('low')) lowCount++;
        });
        
        summarySection.innerHTML = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5>Target: ${escapeHtml(targetUrl)}</h5>
                    <p class="text-muted">Scanned on: ${escapeHtml(formatDate(scanDate))}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <span class="badge bg-danger me-2">${criticalCount} Critical</span>
                    <span class="badge bg-warning text-dark me-2">${highCount} High</span>
                    <span class="badge bg-primary me-2">${mediumCount} Medium</span>
                    <span class="badge bg-info text-dark">${lowCount} Low</span>
                </div>
            </div>
            <div class="d-flex align-items-center mb-3">
                <div class="progress flex-grow-1 me-3" style="height: 10px;">
                    <div class="progress-bar bg-danger" role="progressbar" style="width: ${getPercentage(criticalCount, totalVulns)}%" aria-valuenow="${criticalCount}" aria-valuemin="0" aria-valuemax="${totalVulns}"></div>
                    <div class="progress-bar bg-warning" role="progressbar" style="width: ${getPercentage(highCount, totalVulns)}%" aria-valuenow="${highCount}" aria-valuemin="0" aria-valuemax="${totalVulns}"></div>
                    <div class="progress-bar bg-primary" role="progressbar" style="width: ${getPercentage(mediumCount, totalVulns)}%" aria-valuenow="${mediumCount}" aria-valuemin="0" aria-valuemax="${totalVulns}"></div>
                    <div class="progress-bar bg-info" role="progressbar" style="width: ${getPercentage(lowCount, totalVulns)}%" aria-valuenow="${lowCount}" aria-valuemin="0" aria-valuemax="${totalVulns}"></div>
                </div>
                <span class="badge bg-secondary">${totalVulns} Total</span>
            </div>
        `;
        
        if (window.reportData.hasVulnerabilities) {
            document.getElementById('visualizationDashboard').style.display = 'block';
            createVisualizationCharts(vulnerabilities, criticalCount, highCount, mediumCount, lowCount);
        } else {
             document.getElementById('visualizationDashboard').style.display = 'none';
        }
        
        let vulnerabilityHTML = '';
        vulnerabilityHTML += generateVulnerabilityGroup('Critical', 'danger', vulnerabilities.filter(v => v.severity && v.severity.toLowerCase().includes('critical')));
        vulnerabilityHTML += generateVulnerabilityGroup('High', 'warning', vulnerabilities.filter(v => v.severity && v.severity.toLowerCase().includes('high')));
        vulnerabilityHTML += generateVulnerabilityGroup('Medium', 'primary', vulnerabilities.filter(v => v.severity && v.severity.toLowerCase().includes('medium')));
        vulnerabilityHTML += generateVulnerabilityGroup('Low', 'info', vulnerabilities.filter(v => v.severity && v.severity.toLowerCase().includes('low')));
        
        if (vulnerabilityHTML) {
            document.getElementById('vulnerabilities').innerHTML = vulnerabilityHTML;
        } else {
            document.getElementById('vulnerabilities').innerHTML = `
                <div class="alert alert-success mt-3">
                    <i class="bi bi-check-circle me-2"></i>
                    No structured vulnerabilities found in this scan.
                </div>
            `;
        }
    }
    
    function createVisualizationCharts(vulnerabilities, criticalCount, highCount, mediumCount, lowCount) {
        // Create severity distribution chart (pie chart)
        const severityCtx = document.getElementById('severityChart').getContext('2d');
        new Chart(severityCtx, {
            type: 'doughnut',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    data: [criticalCount, highCount, mediumCount, lowCount],
                    backgroundColor: ['#dc3545', '#ffc107', '#0d6efd', '#0dcaf0'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = total === 0 ? 0 : Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Count by vulnerability type
        const vulnTypes = {};
        vulnerabilities.forEach(vuln => {
            const type = vuln.name || vuln.type || 'Unknown';
            vulnTypes[type] = (vulnTypes[type] || 0) + 1;
        });
        
        // Sort by count (descending)
        const sortedTypes = Object.entries(vulnTypes)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5); // Get top 5
        
        // Create vulnerability type chart (bar chart)
        const typeCtx = document.getElementById('vulnerabilityTypeChart').getContext('2d');
        new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: sortedTypes.map(entry => entry[0]),
                datasets: [{
                    label: 'Count',
                    data: sortedTypes.map(entry => entry[1]),
                    backgroundColor: '#0d6efd',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Top Vulnerability Types'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
        
        // CVSS score chart (if available)
        const vulnsWithCvss = vulnerabilities.filter(v => v.cvss_score && !isNaN(parseFloat(v.cvss_score)));
        if (vulnsWithCvss.length > 0) {
            // Sort by CVSS score (descending)
            vulnsWithCvss.sort((a, b) => parseFloat(b.cvss_score) - parseFloat(a.cvss_score));
            
            const cvssCtx = document.getElementById('cvssScoreChart').getContext('2d');
            new Chart(cvssCtx, {
                type: 'bar',
                data: {
                    labels: vulnsWithCvss.map(v => v.name || v.type || 'Unknown'),
                    datasets: [{
                        label: 'CVSS Score',
                        data: vulnsWithCvss.map(v => parseFloat(v.cvss_score)),
                        backgroundColor: vulnsWithCvss.map(v => {
                            const score = parseFloat(v.cvss_score);
                            if (score >= 9.0) return '#dc3545'; // Critical
                            if (score >= 7.0) return '#ffc107'; // High
                            if (score >= 4.0) return '#0d6efd'; // Medium
                            return '#0dcaf0'; // Low
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 10,
                            title: {
                                display: true,
                                text: 'CVSS Score (0-10)'
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('cvssScoreChart').parentNode.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle me-2"></i>
                    No CVSS score data available for charting.
                </div>
            `;
        }
    }

    function displayMarkdownReport(markdownContent) {
        // UI visibility is handled by showMarkdownViewUIOnly
        // document.getElementById('reportSummary').style.display = 'none';
        // document.getElementById('visualizationDashboard').style.display = 'none';
        // document.getElementById('vulnerabilities').style.display = 'none';
        // document.getElementById('markdownReport').style.display = 'block';


        let content = (typeof markdownContent === 'string') ? markdownContent : '';
        if (!content && markdownContent && typeof markdownContent === 'object') {
             // If markdownContent is an object, but not a string (e.g. from old API that wrapped it)
            if (markdownContent.content && typeof markdownContent.content === 'string') {
                content = markdownContent.content;
            } else {
                 // As a last resort, stringify the object if it's not the expected string
                content = "Error: Markdown content is not in the expected string format.\\n\\nReceived:\\n```json\\n" + JSON.stringify(markdownContent, null, 2) + "\\n```";
            }
        }
        
        const markdownElement = document.getElementById('markdownContent');
        if (window.marked) {
            marked.setOptions({ breaks: true, gfm: true });
            markdownElement.innerHTML = marked.parse(content);
        } else {
            markdownElement.innerHTML = `<pre>${escapeHtml(content)}</pre>`;
        }
    }
    
    function generateVulnerabilityGroup(severityName, colorClass, vulnerabilities) {
        if (!vulnerabilities || vulnerabilities.length === 0) return '';
        
        let html = `
            <div class="card mb-4">
                <div class="card-header bg-${colorClass} text-white">
                    <h5 class="card-title mb-0">${severityName} Severity Vulnerabilities (${vulnerabilities.length})</h5>
                    </div>
                <div class="card-body">
        `;
        
        vulnerabilities.forEach(vuln => {
            const vulnName = vuln.name || vuln.type || 'Unknown Vulnerability';
            const vulnLocation = vuln.location || '';
            const vulnDescription = vuln.description || '';
            const vulnRemediation = vuln.remediation || '';
            const vulnParameter = vuln.parameter || '';
            const vulnCvss = vuln.cvss_score || '';
            
            html += `
                <div class="vulnerability-item mb-4">
                    <h5 class="vuln-title">
                        <span class="badge bg-${colorClass} me-2">${severityName}</span>
                        ${escapeHtml(vulnName)}
                        ${vulnCvss ? `<span class="badge bg-secondary float-end">CVSS: ${vulnCvss}</span>` : ''}
                    </h5>
                    ${vulnLocation ? `<div class="vuln-location"><strong>Location:</strong> ${escapeHtml(vulnLocation)}</div>` : ''}
                    ${vulnParameter ? `<div class="vuln-parameter"><strong>Parameter:</strong> ${escapeHtml(vulnParameter)}</div>` : ''}
                    ${vulnDescription ? `<div class="vuln-description"><strong>Description:</strong> ${escapeHtml(vulnDescription)}</div>` : ''}
                    ${vulnRemediation ? `
                        <div class="vuln-remediation mt-2">
                            <strong>Remediation:</strong>
                            <p>${escapeHtml(vulnRemediation)}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += `
                        </div>
                        </div>
        `;
        
        return html;
    }
    
    function getPercentage(count, total) {
        if (total === 0) return 0;
        return (count / total) * 100;
    }
    
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') {
            if (unsafe === null || unsafe === undefined) return '';
            try {
                return String(unsafe); // Try to convert to string
            } catch (e) {
                return ''; // Return empty if conversion fails
            }
        }
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }
    
    function formatDate(timestamp) {
        if (!timestamp) return 'Unknown';
        
        try {
            if (typeof timestamp === 'number') {
                return new Date(timestamp * 1000).toLocaleString();
            }
            
            if (typeof timestamp === 'string') {
                if (/^\\d+$/.test(timestamp)) {
                    return new Date(parseInt(timestamp) * 1000).toLocaleString();
                }
                if (/^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}$/.test(timestamp)) {
                    return timestamp; // Already well-formatted
                }
                const date = new Date(timestamp); // Try parsing directly
                if (!isNaN(date.getTime())) {
                    return date.toLocaleString();
                }
            }
            return String(timestamp); // Fallback to string conversion
        } catch (e) {
            console.error('Error formatting date:', e, 'Timestamp was:', timestamp);
            return 'Invalid Date';
        }
    }

</script>
<style>
    .markdown-content {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.6;
        color: #333;
    }
    
    .markdown-content h1, 
    .markdown-content h2, 
    .markdown-content h3, 
    .markdown-content h4, 
    .markdown-content h5, 
    .markdown-content h6 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
    }
    
    .markdown-content h1 {
        font-size: 2em;
        border-bottom: 1px solid #eaecef;
        padding-bottom: .3em;
    }
    
    .markdown-content h2 {
        font-size: 1.5em;
        border-bottom: 1px solid #eaecef;
        padding-bottom: .3em;
    }
    
    .markdown-content table {
        display: block;
        width: 100%;
        overflow: auto;
        border-spacing: 0;
        border-collapse: collapse;
        margin-top: 16px;
        margin-bottom: 16px;
    }
    
    .markdown-content table tr {
        background-color: #fff;
        border-top: 1px solid #c6cbd1;
    }
    
    .markdown-content table tr:nth-child(2n) {
        background-color: #f6f8fa;
    }
    
    .markdown-content table th, 
    .markdown-content table td {
        padding: 6px 13px;
        border: 1px solid #dfe2e5;
    }
    
    .markdown-content table th {
        font-weight: 600;
    }
    
    .markdown-content pre {
        background-color: #f6f8fa;
        border-radius: 3px;
        padding: 16px;
        overflow: auto;
    }
    
    .markdown-content code {
        background-color: rgba(27,31,35,.05);
        border-radius: 3px;
        padding: .2em .4em;
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    }
    
    .markdown-content pre code {
        background-color: transparent;
        padding: 0;
    }
    
    /* Chart container styling */
    .chart-container {
        position: relative;
        height: 100%;
        width: 100%;
    }
    
    /* Dashboard card styling */
    .card-header h6 {
        font-weight: 600;
    }
    
    /* Badge styling for CVSS scores */
    .badge.cvss-badge {
        min-width: 60px;
    }
</style>
{% endblock %} 